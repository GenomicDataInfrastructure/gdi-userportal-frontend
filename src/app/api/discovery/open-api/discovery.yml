# SPDX-FileCopyrightText: 2024 PNED G.I.E.
#
# SPDX-License-Identifier: Apache-2.0

openapi: 3.0.3
info:
  title: Dataset Discovery Service - OpenAPI 3.0
  description: |-
    This is the OpenAPI 3.0 specification for the Dataset Discovery Service.
    This service is responsible for dataset discovery, in the scope of Genomic Data Infrastructure (GDI).
    The service provides endpoints for searching datasets, and retrieving DCAT-AP metadata.

  #termsOfService: http://TODO/terms/
  contact:
    email: gdi-WP4@elixir-europe.org
  license:
    name: Apache 2.0
    url: https://spdx.org/licenses/Apache-2.0.html
  version: 0.0.0
externalDocs:
  description: Find out more about GDI
  url: https://genomicdatainfrastructure.github.io/gdi-userportal-docs/
servers:
  - url: https://localhost:8080
    description: Development server
paths:
  /api/v1/datasets/search:
    post:
      summary: Searches for packages based on criteria
      operationId: dataset_search
      tags:
        - "dataset-query"
      parameters:
        - $ref: "#/components/parameters/AcceptLanguage"
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DatasetSearchQuery"
      responses:
        "200":
          description: A list of datasets matching the search criteria
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DatasetsSearchResponse"
      security:
        - discovery_auth:
            - read:datasets
  /api/v1/datasets/{id}:
    get:
      summary: Retrieves a dataset by its ID
      operationId: retrieve_dataset
      tags:
        - "dataset-query"
      parameters:
        - name: id
          in: path
          description: The ID of the dataset to retrieve
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/AcceptLanguage"
      responses:
        "200":
          description: The dataset
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RetrievedDataset"
        "404":
          description: Dataset not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      security:
        - discovery_auth:
            - read:datasets
  /api/v1/datasets/{id}.{format}:
    get:
      summary: Retrieves a dataset by its ID, in the requested format
      operationId: retrieve_dataset_in_format
      tags:
        - "dataset-query"
      parameters:
        - name: id
          in: path
          description: The ID of the dataset to retrieve
          required: true
          schema:
            type: string
        - name: format
          in: path
          description: the expected format of the response
          required: true
          schema:
            type: string
            enum:
              - jsonld
              - rdf
              - ttl
      responses:
        "200":
          description: The dataset in the requested format
          content:
            application/ld+json:
              schema:
                type: string
            application/rdf+xml:
              schema:
                type: string
            text/turtle:
              schema:
                type: string
        "404":
          description: Dataset not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
      security:
        - discovery_auth:
            - read:datasets
  /api/v1/filters:
    get:
      summary: Retrieves filters for querying datasets
      operationId: retrieve_filters
      tags:
        - "filters-query"
      parameters:
        - $ref: "#/components/parameters/AcceptLanguage"
      responses:
        "200":
          description: A list of filters
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Filter"
      security:
        - discovery_auth:
            - read:search-facets
  /api/v1/filters/{key}/values:
    get:
      summary: Retrieves the values for a filter key
      operationId: retrieve_filter_values
      tags:
        - "filters-query"
      parameters:
        - $ref: "#/components/parameters/AcceptLanguage"
        - name: key
          in: path
          description: The key of the filter to retrieve values for
          required: true
          schema:
            type: string
      responses:
        "200":
          description: The values for the filter key
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ValueLabel"
      security:
        - discovery_auth:
            - read:search-facets

  /api/v1/g_variants:
    post:
      description: Search for allele frequencies
      operationId: searchGenomicVariants
      tags:
        - g_variants
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GVariantSearchQuery"
      responses:
        "200":
          description: A list of datasets matching the search criteria
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/GVariantsSearchResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Dataset not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  parameters:
    AcceptLanguage:
      name: Accept-Language
      in: header
      description: Preferred language for the response
      required: false
      schema:
        type: string
        example: en
  securitySchemes:
    discovery_auth:
      type: oauth2
      description: This API uses OAuth 2 with the implicit grant flow.
      flows:
        authorizationCode:
          tokenUrl: https://api.example.com/oauth2/token
          authorizationUrl: https://api.example.com/oauth2/authorize
          scopes:
            read:datasets: read datasets
  schemas:
    DatasetSearchQuery:
      type: object
      properties:
        query:
          type: string
          title: Solr search query
        facets:
          type: array
          title: Facets
          items:
            $ref: "#/components/schemas/DatasetSearchQueryFacet"
        sort:
          type: string
          title: Sorting of search results
          default: "score desc, metadata_modified desc"
        rows:
          type: integer
          title: Max number of rows to return
          default: 10
          minimum: 0
          maximum: 1000
        start:
          type: integer
          title: Offset in the complete result set
          default: 0
          minimum: 0
        operator:
          allOf:
            - $ref: "#/components/schemas/QueryOperator"
            - title: Ckan query operator
              default: OR
        includeBeacon:
          type: boolean
          title: Include Beacon Network in search
          description: |
            Whether to include Beacon Network results in the search.
            - true (default): Search both CKAN and Beacon, return intersection with record counts
            - false: Search CKAN only (faster, no Beacon query, no record counts)

            For backward compatibility, if not provided, defaults to true.
          default: true
    DatasetSearchQueryFacet:
      type: object
      properties:
        source:
          type: string
          title: Facet source
        type:
          $ref: "#/components/schemas/FilterType"
        key:
          type: string
          title: Facet key
        value:
          type: string
          title: Facet value
        operator:
          $ref: "#/components/schemas/Operator"
        entries:
          type: array
          items:
            $ref: "#/components/schemas/QueryEntry"
      required:
        - source
        - type
        - label
    FilterType:
      type: string
      enum:
        - DROPDOWN
        - FREE_TEXT
        - ENTRIES
        - DATETIME
        - NUMBER
      title: Filter type
    Operator:
      default: "="
      description: Defines how the value relates to the field `id`.
      enum:
        - "="
        - "<"
        - ">"
        - "!"
        - ">="
        - "<="
      example: ">"
      type: string
    QueryEntry:
      properties:
        key:
          type: string
          title: label
        value:
          type: string
          title: value
      required:
        - key
        - value
    QueryOperator:
      type: string
      enum:
        - OR
        - AND
      title: Query operator
    SearchedDataset:
      type: object
      properties:
        id:
          type: string
          title: Identifier
        identifier:
          type: string
          title: Identifier
        title:
          type: string
          title: Title
        description:
          type: string
          title: Description
        publishers:
          type: array
          items:
            $ref: "#/components/schemas/Agent"
        themes:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
          title: Themes
        keywords:
          type: array
          items:
            type: string
          title: Keywords
        catalogue:
          type: string
          title: Catalogue
        modifiedAt:
          type: string
          format: date-time
          title: Dataset modified at
        createdAt:
          type: string
          format: date-time
          title: Metadata for dataset created at
        accessRights:
          $ref: "#/components/schemas/ValueLabel"
        conformsTo:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
          title: Conforms To
        numberOfUniqueIndividuals:
          type: integer
          minimum: 0
        temporalCoverage:
          $ref: "#/components/schemas/TimeWindow"
        recordsCount:
          type: integer
          title: Records count
        distributionsCount:
          type: integer
          title: Distributions count
      required:
        - id
        - title
        - description
    DatasetsSearchResponse:
      type: object
      properties:
        count:
          type: integer
          description: The number of results found
        results:
          type: array
          items:
            $ref: "#/components/schemas/SearchedDataset"
        beaconError:
          type: string
          description: Error message if beacon query failed
    RetrievedDataset:
      type: object
      properties:
        id:
          type: string
          title: Dataset internal ID
        identifier:
          type: string
          title: Identifier
        title:
          type: string
          title: Title
        description:
          type: string
          title: Description
        version:
          type: string
          title: Version
          description: Version number or other version designation of the dataset.
        license:
          type: string
          title: License
          description: License identifier for the dataset.
        ownerOrg:
          type: string
          title: Owner Organization
          description: The CKAN organization the dataset belongs to.
        themes:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        contacts:
          type: array
          items:
            $ref: "#/components/schemas/ContactPoint"
        datasetRelationships:
          type: array
          items:
            $ref: "#/components/schemas/DatasetRelationEntry"
        dataDictionary:
          type: array
          items:
            $ref: "#/components/schemas/DatasetDictionaryEntry"
        catalogue:
          type: string
          title: Catalogue
        createdAt:
          type: string
          format: date-time
          title: Dataset created at
        modifiedAt:
          type: string
          format: date-time
          title: Dataset modified at
        url:
          type: string
          title: Dataset URL
        languages:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        creators:
          type: array
          items:
            $ref: "#/components/schemas/Agent"
        publishers:
          type: array
          items:
            $ref: "#/components/schemas/Agent"
        hasVersions:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
          deprecated: true
        accessRights:
          $ref: "#/components/schemas/ValueLabel"
        conformsTo:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
          deprecated: true
        keywords:
          type: array
          items:
            type: string
        provenance:
          type: string
          title: Provenance
        spatial:
          $ref: "#/components/schemas/ValueLabel"
        distributions:
          type: array
          items:
            $ref: "#/components/schemas/RetrievedDistribution"
          title: Distributions
        dcatType:
          $ref: "#/components/schemas/ValueLabel"
        # Below are properties from HealthDCAT
        publisherNote:
          type: string
          description: A note from the publisher about the dataset.
        publisherCoverage:
          type: array
          items:
            type: string
        publisherType:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        trustedDataHolder:
          type: boolean
        hdab:
          type: array
          items:
            $ref: "#/components/schemas/Agent"
        spatialCoverage:
          type: array
          description: A geographic region that is covered by the dataset.
          items:
            $ref: "#/components/schemas/SpatialCoverage"
        spatialResolutionInMeters:
          type: number
          format: float
          description: Minimum spatial separation resolvable in a dataset, measured in meters.
        temporalCoverage:
          $ref: "#/components/schemas/TimeWindow"
        temporalResolution:
          type: string
        populationCoverage:
          type: string
        retentionPeriod:
          type: array
          items:
            $ref: "#/components/schemas/TimeWindow"
        purpose:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        legalBasis:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        applicableLegislation:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        healthTheme:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        healthCategory:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        maxTypicalAge:
          type: integer
        minTypicalAge:
          type: integer
        numberOfRecords:
          type: integer
        numberOfUniqueIndividuals:
          type: integer
        analytics:
          type: array
          items:
            type: string
        codeValues:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        codingSystem:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        alternateIdentifier:
          type: array
          items:
            type: string
        versionNotes:
          type: string
        qualifiedRelation:
          type: array
          items:
            type: object
            properties:
              relation:
                type: string
              role:
                $ref: "#/components/schemas/ValueLabel"
        personalData:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        homepage:
          type: string
        uri:
          type: string
        documentation:
          type: array
          items:
            type: string
        frequency:
          $ref: "#/components/schemas/ValueLabel"
        inSeries:
          type: array
          items:
            type: string
        isReferencedBy:
          type: array
          items:
            type: string
        provenanceActivity:
          type: array
          items:
            type: object
            properties:
              dct_type:
                type: string
              label:
                type: string
              seeAlso:
                type: string
              startedAtTime:
                type: string
              uri:
                type: string
              wasAssociatedWith:
                type: array
                items:
                  $ref: "#/components/schemas/Agent"
        qualityAnnotation:
          type: array
          items:
            type: object
            properties:
              body:
                $ref: "#/components/schemas/ValueLabel"
              motivatedBy:
                $ref: "#/components/schemas/ValueLabel"
              target:
                type: string
        qualifiedAttribution:
          type: array
          items:
            type: object
            properties:
              role:
                type: object
              agent:
                type: array
                items:
                  $ref: "#/components/schemas/Agent"
      required:
        - id
        - title
        - description
    RetrievedDistribution:
      type: object
      properties:
        accessUrl:
          type: string
          title: Access URL
        applicableLegislation:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        byteSize:
          type: integer
          format: int64
          minimum: 0
        checksum:
          type: string
        checksumAlgorithm:
          $ref: "#/components/schemas/ValueLabel"
        compressionFormat:
          type: string
        description:
          type: string
          title: Description
        documentation:
          type: array
          items:
            type: string
        downloadUrl:
          type: string
          title: Download URL
        format:
          $ref: "#/components/schemas/ValueLabel"
        languages:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        license:
          $ref: "#/components/schemas/ValueLabel"
        conformsTo:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
        mediaType:
          type: string
        modifiedAt:
          type: string
          format: date-time
          title: Distribution modified at
        packagingFormat:
          type: string
        createdAt:
          type: string
          format: date-time
          title: Distribution created at
        retentionPeriod:
          type: array
          items:
            $ref: "#/components/schemas/TimeWindow"
        rights:
          type: string
        status:
          $ref: "#/components/schemas/ValueLabel"
        temporalResolution:
          type: string
        title:
          type: string
          title: Title
        availability:
          type: string
        id:
          type: string
          title: Distribution internal ID
        spatialResolutionInMeters:
          type: number
          format: float
        uri:
          type: string
        accessService:
          type: array
          title: Access service
          items:
            type: object
            properties:
              accessRights:
                $ref: "#/components/schemas/ValueLabel"
              applicableLegislation:
                type: array
                items:
                  $ref: "#/components/schemas/ValueLabel"
              conformsTo:
                type: array
                items:
                  $ref: "#/components/schemas/ValueLabel"
              contact:
                type: array
                items:
                  $ref: "#/components/schemas/ContactPoint"
              creator:
                type: array
                items:
                  $ref: "#/components/schemas/Agent"
              rights:
                type: array
                items:
                  type: string
              description:
                type: string
              endpointDescription:
                type: string
              endpoint_url:
                type: array
                items:
                  type: string
              format:
                type: array
                items:
                  $ref: "#/components/schemas/ValueLabel"
              id:
                type: string
                title: Data service internal ID
              keywords:
                type: array
                items:
                  type: string
              landingPage:
                type: array
                items:
                  type: string
              languages:
                type: array
                items:
                  $ref: "#/components/schemas/ValueLabel"
              license:
                $ref: "#/components/schemas/ValueLabel"
              modified:
                type: string
                format: date-time
              publisher:
                type: array
                items:
                  $ref: "#/components/schemas/Agent"
              servesDataset:
                type: array
                items:
                  type: string
              theme:
                type: array
                items:
                  $ref: "#/components/schemas/ValueLabel"
              uri:
                type: string
              title:
                type: string
              hvdCategory:
                type: array
                description: A data category defined in the High Value Dataset Implementing Regulation.
                items:
                  $ref: "#/components/schemas/ValueLabel"
            required:
              - id
              - title
              - description

      required:
        - id
        - title
        - description

    ValueLabel:
      properties:
        value:
          type: string
          title: value
        label:
          type: string
          title: label
        count:
          type: integer
          title: count
      required:
        - value
        - label
    ContactPoint:
      properties:
        name:
          type: string
          title: name
        email:
          type: string
          title: email
        uri:
          type: string
          title: uri
        url:
          type: string
          title: url
          description: URL for more information about the contact point.
        identifier:
          type: string
          title: identifier
          description: Unique identifier for the contact point.
      required:
        - name
        - email
    Agent:
      properties:
        name:
          type: string
          title: name
        email:
          type: string
          title: email
        url:
          type: string
          title: url
        uri:
          type: string
          title: uri
        homepage:
          type: string
          title: homepage
          description: Homepage URL for the agent.
        type:
          $ref: "#/components/schemas/ValueLabel"
        identifier:
          type: string
          title: identifier
        actedOnBehalfOf:
          type: array
          description: Organization the agent acted on behalf of.
          items:
            $ref: "#/components/schemas/Agent"
      required:
        - name
    DatasetRelationEntry:
      properties:
        relation:
          type: string
          title: relation
        target:
          type: string
          title: target
      required:
        - target
        - relation
    DatasetDictionaryEntry:
      properties:
        name:
          type: string
          title: name
        type:
          type: string
          title: type
        description:
          type: string
          title: description
      required:
        - name
        - type
        - description
    TimeWindow:
      properties:
        start:
          type: string
          format: date-time
        end:
          type: string
          format: date-time
    SpatialCoverage:
      type: object
      properties:
        uri:
          $ref: "#/components/schemas/ValueLabel"
        text:
          type: string
          description: Label
        geom:
          type: string
          description: Geometry
        bbox:
          type: string
          description: Bounding Box
        centroid:
          type: string
          description: Centroid
    Filter:
      type: object
      properties:
        source:
          type: string
          title: Filter source
        group:
          type: string
          title: Filter group
        type:
          $ref: "#/components/schemas/FilterType"
        key:
          type: string
          title: Key
        label:
          type: string
          title: Label
        values:
          type: array
          items:
            $ref: "#/components/schemas/ValueLabel"
          title: values
        range:
          $ref: "#/components/schemas/FilterRange"
        operators:
          type: array
          items:
            $ref: "#/components/schemas/Operator"
        entries:
          type: array
          items:
            $ref: "#/components/schemas/FilterEntry"
          title: entries
      required:
        - source
        - type
        - key
        - label
    FilterRange:
      type: object
      properties:
        min:
          type: string
          title: minimum value supported by the filter
        max:
          type: string
          title: maximum value supported by the filter
    FilterEntry:
      type: object
      properties:
        key:
          type: string
          title: id
        label:
          type: string
          title: label
      required:
        - key
        - label
    ErrorResponse:
      type: object
      properties:
        title:
          type: string
          title: Error title
        status:
          type: integer
          title: Error status
        detail:
          type: string
          title: Error detail
      required:
        - title
        - status
    GVariantSearchQuery:
      type: object
      properties:
        params:
          $ref: "#/components/schemas/GVariantSearchQueryParams"
      required:
        - params
    GVariantSearchQueryParams:
      type: object
      properties:
        referenceName:
          type: string
          title: Reference Name
          description: Chromosome name/identifier
          example: "3"
        start:
          type: array
          title: Start Position
          description: Array of start positions on the reference sequence
          items:
            type: integer
          example: [45864731]
        end:
          type: array
          title: End Position
          description: Array of end positions on the reference sequence (can be null)
          items:
            type: integer
          nullable: true
        referenceBases:
          type: string
          title: Reference Bases
          description: The reference allele sequence
          example: "T"
        alternateBases:
          type: string
          title: Alternate Bases
          description: The alternate allele sequence
          example: "C"
        assemblyId:
          type: string
          title: Assembly ID
          description: Reference genome assembly identifier
          example: "GRCh37"
        sex:
          type: string
          title: Sex
          description: Optional sex filter (M or F)
          example: "F"
        countryOfBirth:
          type: string
          title: Country of Birth
          description: Optional country of birth (2-letter ISO code)
          example: "FR"
      required:
        - referenceName
        - start
        - referenceBases
        - alternateBases
        - assemblyId
    GVariantsSearchResponse:
      type: object
      properties:
        beacon:
          type: string
          example: fi.csc.gdi-aggregate-beacon
        dataset:
          type: string
          example: COVID_pop12_ita_2
          deprecated: true
          description: "This field is deprecated. Use datasetId instead."
        datasetId:
          type: string
          description: The dataset identifier
          example: GDID-italysub2-6666
        population:
          type: string
          description: Population name in GoE format [COUNTRY]_[SEX] where COUNTRY is 2-letter ISO code and SEX is M or F. Examples FR_M, FR_F, FR, M, F
          example: FR_M
        sex:
          type: string
          title: Sex
        countryOfBirth:
          type: string
          title: Country of Birth
        alleleCount:
          type: number
        alleleNumber:
          type: number
        alleleCountHomozygous:
          type: number
        alleleCountHeterozygous:
          type: number
        alleleCountHemizygous:
          type: number
        alleleFrequency:
          type: number

    QualifiedAttribution:
      type: object
      properties:
        role:
          $ref: "#/components/schemas/ValueLabel"
        agent:
          type: array
          items:
            $ref: "#/components/schemas/Agent"

    ProvenanceActivity:
      type: object
      properties:
        dct_type:
          type: string
        label:
          type: string
        seeAlso:
          type: string
        startedAtTime:
          type: string
        uri:
          type: string
        wasAssociatedWith:
          type: array
          items:
            $ref: "#/components/schemas/Agent"
